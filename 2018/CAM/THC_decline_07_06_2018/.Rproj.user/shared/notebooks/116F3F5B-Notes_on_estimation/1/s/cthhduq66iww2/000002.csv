"0","estimate_ed_lm = function( x, y ) {"
"0","  # Purpose:"
"0","  # Fits an exponential decay model via "
"0","  # tobit log-linear regression."
"0","  # Arguments:"
"0","  # x    - The independent variable"
"0","  # y    - The dependent variable"
"0","  # Returns:"
"0","  # A list with the parameter estimates,"
"0","  # the predicted THCCOOH levels, "
"0","  # and the residals."
"0","  "
"0","  # Straightforward estimation of the "
"0","  # power law and exponential decay models "
"0","  # requires log transformations, so we "
"0","  # first check for zeroes in the dependent "
"0","  # variable"
"0","  is_zero = y == 0"
"0","  "
"0","  # If there are no zero values, we can simply "
"0","  # use a log-linear model to estimate the "
"0","  # 3 parameters in the model"
"0","  if ( !any( is_zero ) ) {"
"0","    "
"0","    lmf = lm( log( y ) ~ 1 + x )"
"0","    est = c( coef( lmf ), sigma( lmf ) )"
"0","    est[1] = exp( est[1] )"
"0","    est[2] = -est[2]"
"0","    "
"0","  } else {"
"0","    "
"0","    # If there are zeros, we can treat them "
"0","    # as censored data (i.e., the actual "
"0","    # values are actually non-zero, but "
"0","    # any value less than a cut-off was "
"0","    # rounded down to zero). Therefore, "
"0","    # we can use tobit regression to "
"0","    # fit the log-linear model"
"0","    "
"0","    # First, we use the naive estimator "
"0","    # to determine the starting values "
"0","    # for the optimization routine"
"0","    sel = y > 0"
"0","    ne = lm( log( y[sel] ) ~ 1 + x[sel] )"
"0","    st_val = c( coef( ne ), sigma( ne ) )"
"0","    st_val[1] = exp( st_val[1] )"
"0","    st_val[2] = -st_val[2]"
"0","    "
"0","    # Set up data to analyze"
"0","    dat = list("
"0","      x = x,"
"0","      y = y,"
"0","      a = 1"
"0","    )"
"0","    # We can then use the tobit regression likelihood "
"0","    # to estimate the parameters of interest despite "
"0","    # the censored data"
"0","    tbtf = tryCatch("
"0","      optim( st_val, mle_ed_tobit, dat = dat,"
"0","             control = list( maxit = 1000 ) ),"
"0","      error = function(e) NULL"
"0","    )"
"0","    "
"0","    # If the MLE worked"
"0","    if ( !is.null( tbtf ) ) {"
"0","      "
"0","      est = tbtf$par"
"0","      "
"0","    } else {"
"0","      est = st_val"
"0","      warning( 'Tobit regression failed' )"
"0","    }"
"0","    "
"0","  }"
"0","  names( est ) = c( 'Baseline', 'Elimination', 'Error' )"
"0","  "
"0","  # Generate predicted THCCOOH levels"
"0","  pred = ed_model( est, x )"
"0","  # Compute residuals"
"0","  resid_val = y - pred"
"0","  "
"0","  return( list( est = est, "
"0","                x = x, "
"0","                pred = pred, "
"0","                resid = resid_val ) )"
"0","  "
"0","}"
"0","# Create a blank plot"
"0","xl = c( -1, 35 )"
"0","yl = lowerUpper( 1, sim_dat$log_THCCOOH.obs )"
"0","blankPlot( xl, yl )"
